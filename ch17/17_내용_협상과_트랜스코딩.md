# 17. 내용 협상과 트랜스코딩

- 웹 서버는 동일한 리소스에 대해 여러 가지 표현을 제공할 수 있다. 예를 들어, 같은 문서를 영어, 프랑스어, 한국어로 제공하거나, HTML, PDF, 텍스트 형식으로 제공할 수 있다.
- 내용 협상(Content Negotiation)은 클라이언트와 서버가 서로 가장 적합한 리소스 표현을 선택하는 과정이다.
- 트랜스코딩(Transcoding)은 서버가 클라이언트의 요구에 맞게 리소스를 변환하는 과정이다.
- 이번 장에서는 다양한 내용 협상 기법과 트랜스코딩 방법을 다룬다.

## 17.1 내용 협상 기법

- 내용 협상은 클라이언트와 서버가 서로 가장 적합한 리소스 표현을 선택하는 메커니즘이다.
- HTTP는 세 가지 주요 협상 기법을 제공한다.
  - 클라이언트 주도 협상: 클라이언트가 선택
  - 서버 주도 협상: 서버가 선택
  - 투명 협상: 중간 프락시가 선택

### 17.1.1 협상의 차원

- 내용 협상은 여러 차원에서 이루어질 수 있다.
  - 콘텐츠의 미디어 타입: text/html, text/plain, application/pdf 등
  - 콘텐츠의 언어: ko, en, fr 등
  - 콘텐츠의 문자 인코딩: UTF-8, ISO-8859-1 등
  - 콘텐츠의 압축 방식: gzip, compress 등

## 17.2 클라이언트 주도 협상

- 클라이언트 주도 협상은 서버가 사용 가능한 모든 리소스 표현의 목록을 클라이언트에 제공하고, 클라이언트가 직접 선택하는 방식이다.
- 서버는 300 Multiple Choices 응답을 보내거나, HTML 페이지에 선택 가능한 링크 목록을 제공한다.

### 17.2.1 클라이언트 주도 협상의 장단점

- 장점
  - 구현이 간단하다. 서버는 모든 표현을 제공하고 클라이언트가 선택한다.
  - 클라이언트가 자신의 선호도를 정확히 반영할 수 있다.
- 단점
  - 추가 요청이 필요하다. 클라이언트는 먼저 목록을 받고, 그 다음 원하는 표현을 선택해야 한다.
  - 사용자 경험이 좋지 않다. 사용자가 직접 선택해야 하는 경우가 많다.

## 17.3 서버 주도 협상

- 서버 주도 협상은 서버가 클라이언트의 요청 헤더를 분석하여 가장 적합한 표현을 선택하는 방식이다.
- 클라이언트는 Accept, Accept-Language, Accept-Charset, Accept-Encoding 등의 헤더를 통해 선호도를 전달한다.

### 17.3.1 Accept 헤더

- Accept 헤더는 클라이언트가 선호하는 미디어 타입을 서버에 알려준다.

```http
Accept: text/html, application/xhtml+xml, application/xml;q=0.9, */*;q=0.8
```

- q 값(품질 지수)은 0.0부터 1.0까지의 값으로, 선호도를 나타낸다. 값이 높을수록 더 선호한다.
- 위 예제에서 text/html이 가장 선호되고, application/xml은 0.9의 선호도를 가지며, 나머지는 0.8의 선호도를 가진다.

### 17.3.2 Accept-Language 헤더

- Accept-Language 헤더는 클라이언트가 선호하는 언어를 서버에 알려준다.

```http
Accept-Language: ko-KR, ko;q=0.9, en-US;q=0.8, en;q=0.7
```

### 17.3.3 Accept-Charset 헤더

- Accept-Charset 헤더는 클라이언트가 선호하는 문자 인코딩을 서버에 알려준다.

```http
Accept-Charset: UTF-8, ISO-8859-1;q=0.5
```

### 17.3.4 Accept-Encoding 헤더

- Accept-Encoding 헤더는 클라이언트가 선호하는 압축 방식을 서버에 알려준다.

```http
Accept-Encoding: gzip, deflate, br
```

### 17.3.5 서버 주도 협상의 장단점

- 장점
  - 추가 요청이 필요 없다. 서버가 바로 적절한 표현을 제공한다.
  - 사용자 경험이 좋다. 사용자가 별도로 선택할 필요가 없다.
- 단점
  - 서버가 클라이언트의 선호도를 정확히 파악하기 어려울 수 있다.
  - 서버의 부담이 증가한다. 모든 표현을 준비하고 선택 로직을 구현해야 한다.

## 17.4 투명 협상

- 투명 협상은 중간 프락시가 클라이언트와 서버 사이에서 협상을 대신 수행하는 방식이다.
- 프락시는 클라이언트의 선호도와 서버의 가능한 표현을 모두 알고 있으므로, 최적의 선택을 할 수 있다.

### 17.4.1 Vary 헤더

- Vary 헤더는 서버가 응답을 생성할 때 어떤 요청 헤더를 고려했는지를 나타낸다.

```http
Vary: Accept-Language, Accept-Encoding
```

- 이 헤더는 캐시가 올바른 표현을 저장하고 제공하는 데 도움을 준다.
- 캐시는 Vary 헤더에 명시된 요청 헤더의 값에 따라 다른 표현을 저장해야 한다.

### 17.4.2 투명 협상의 장단점

- 장점
  - 클라이언트와 서버의 부담을 줄인다. 프락시가 협상을 처리한다.
  - 캐시 효율을 높일 수 있다. 프락시가 적절한 표현을 캐시할 수 있다.
- 단점
  - 프락시의 복잡도가 증가한다.
  - 모든 프락시가 투명 협상을 지원하지 않을 수 있다.

## 17.5 트랜스코딩

- 트랜스코딩은 서버가 클라이언트의 요구에 맞게 리소스를 변환하는 과정이다.
- 트랜스코딩은 원본 리소스의 포맷을 다른 포맷으로 변환하거나, 리소스의 일부만 추출하거나, 리소스를 압축하는 등의 작업을 포함한다.

### 17.5.1 포맷 변환

- 포맷 변환은 리소스를 다른 미디어 타입으로 변환하는 것이다.
  - HTML을 텍스트로 변환
  - 이미지를 다른 형식으로 변환 (JPEG → PNG)
  - 문서를 PDF로 변환

### 17.5.2 정보 합성

- 정보 합성은 여러 리소스를 하나로 합치는 것이다.
  - 여러 이미지를 하나의 갤러리로 합성
  - 여러 문서를 하나의 문서로 통합

### 17.5.3 콘텐츠 주입

- 콘텐츠 주입은 원본 리소스에 추가 정보를 삽입하는 것이다.
  - 광고 삽입
  - 사용자 맞춤 정보 추가
  - 네비게이션 요소 추가

### 17.5.4 트랜스코딩의 장단점

- 장점
  - 클라이언트가 원하는 형식으로 리소스를 받을 수 있다.
  - 대역폭을 절약할 수 있다. 예를 들어, 이미지를 압축하거나 저해상도로 변환할 수 있다.
  - 다양한 클라이언트를 지원할 수 있다. 모바일 기기나 저사양 기기에도 적합한 형식으로 변환할 수 있다.
- 단점
  - 서버의 부담이 증가한다. 실시간 변환은 CPU와 메모리를 많이 사용한다.
  - 원본의 품질이 손실될 수 있다. 변환 과정에서 정보가 손실되거나 왜곡될 수 있다.
  - 캐싱이 어려울 수 있다. 변환된 결과는 요청마다 다를 수 있어 캐시하기 어렵다.

## 17.6 다음 단계

- 내용 협상과 트랜스코딩은 웹에서 다양한 클라이언트와 사용자를 지원하는 중요한 메커니즘이다.
- 현대 웹에서는 RESTful API를 통해 다양한 형식의 리소스를 제공하거나, CDN을 통해 최적화된 콘텐츠를 제공하는 등의 방법으로 내용 협상과 트랜스코딩을 활용한다.
- HTTP/2와 HTTP/3에서는 더 효율적인 협상 메커니즘이 제공될 수 있다.

## 17.7 추가 정보

- 내용 협상과 트랜스코딩에 대한 더 자세한 정보는 HTTP 명세서와 관련 RFC 문서를 참고할 수 있다.
- 실제 구현 시에는 서버의 성능과 클라이언트의 요구사항을 고려하여 적절한 협상 방식을 선택해야 한다.

