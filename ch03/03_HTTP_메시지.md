# 03. HTTP 메시지

- 메시지가 어떻게 흘러가는가
- HTTP 메시지의 세 부분(시작줄, 헤더, 개체 본문)
- 요처과 응답 메시지의 차이
- 요청 메시지가 지원하는 여러 기능(메서드)들
- 응답 메시지가 반환하는 여러 상태 코드들
- 여러 HTTP 헤더들은 무슨일을 하는가

## 3.1 메시지의 흐름

- HTTP 메시지는 HTTP 어플리케이션 간에 주고받은 데이터의 블록

### 3.1.1 메시지는 원 서버 방향을 인바운드로 하여 송신된다

- 인바운드 : 원래의 서버로 이동하는 방향
- 아웃바운드 : 서버에서의 처리가 끝난 다음 사용자 에이전트로의 방향

### 3.1.2 다운 스트림으로 흐르는 메시지

- 흐름의 방향에서 상위의 요소는 업 스트림, 하위의 요소는 다운 스트림

## 3.2 메시지의 각 부분

- 메시지는 시작 줄, 헤더 블록, 본문으로 구성
- 시작 줄 : 이것이 어떤 메시지인지 서술, 캐리지 리턴(HTTP 명세) 또는 개행 문자로 구분
- 헤더 블록 : 속성, 캐리지 리턴(HTTP 명세) 또는 개행 문자로 구분
- 본문 : 데이터, 비어 있거나 텍스트나 이진 데이터 포함 가능

### 3.2.1 메시지 문법

- 요청 메시지는 웹 서버에 어떤 동작을 요구
```
<메서드> <요청 URL> <버전>
<헤더>

<엔터티 본문>
```

- 응답 메시지를 요청 메시지의 결과를 응답
```
<버전> <상태 코드> <사유 구정>
<헤더>

<엔터티 본문>
```

![img.png](03_http_msg_01.png)

#### 메서드
- 클라이언트 측에서 서버가 리로스에 대해 수행해주길 바라는 동작, GET / HEAD / POST 등

#### 요청 URL
- 요청 되상이 되는 리소스를 지칭하는 완전한 URL

#### 버전
- 메세지에서 사용 중인 HTTP 의 버전, `HTTP/<메이저 버전>.<마이너 버전>`

#### 상태 코드
- 요청 중에 무엇이 일어났는지 설명하는 세 자리의 숫자

#### 사유 구절
- 숫자 상태 코드의 의미를 사람이 이해할 수 있도록 설명해 주는 도구, 프로토콜의 규약에는 상관 없이 사람의 이해를 위해서만 사용

#### 헤더들
- 추후 자세히 다룰 예정

#### 엔터티 본문
- 임의 데이터 블록을 포함 하거니 빈 상태(CRLF)로 전달
- 엔터티 본문이 없어도 헤더 다음에 CRLF 가 있어야 하는 것이 규약

### 3.2.2 시작 줄

##### 요청 줄
- 메서드 / 요청 URL / HTTP 버전이 포함 되며, 공백으로 구분
- `ex) GET /test/hi-there.txt HTTP/1.1`

#### 응답 줄
- HTTP 버전 / 상태 코드 / 사유 구절
- `ex) HTTP/1.0 200 OK`

#### 메서드
- 서버에 무엇을 해야하는지 알려주는 규약
- 단, 서버 별로 구현된 메서드가 다를 수 있으니 주의 필요

| 메서드     | 설명                             | 메시지 본문 |
|:--------|:-------------------------------|:------:|
| GET     | 서버에서 어떤 문서를 가져온다               |   X    |
| HEAD    | 서버에서 어떤 문서에 대한 헤더만 가져온다        |   X    |
| POST    | 서버가 처리해야할 데이터를 보낸다             |   O    |
| PUT     | 서버에 요청 메시지의 본문을 저장한다           |   O    |
| TRACE   | 메시지가 프락시를 거쳐 서버에 도달하는 과정을 추적한다 |   X    |
| OPTIONS | 서버가 어떤 메서드를 수행할 수 있는지 확인한다     |   X    |
| DELETE  | 서버에서 문서를 제거한다                  |   X    |

#### 상태 코드
- 클라이언트에게 서버에서 무엇이 일어났는지 알려주는 3자리 코드

|   전체 범위   |  정의된 범위   |    분류    |
|:---------:|:---------:|:--------:|
| 100 - 199 | 100 - 101 |    정보    |
| 200 - 299 | 200 - 206 |    성공    |
| 300 - 399 | 300 - 305 |  리다이렉션   |
| 400 - 499 | 400 - 415 | 클라이언트 애러 |
| 500 - 599 | 500 - 505 |  서버 에러   |

#### 사유 구절
- 상태 코드를 사람이 이해할 수 있도록 설명한 버전

#### 버전 번호
- HTTP 프로토콜의 버전을 알려주는 역할
- 한 쪽, 버전이 낮을 경우 낮은 버전의 기능을 사용해서만 통신


### 3.2.3 헤더

- 요청과 응답 메시지에 추가 정보를 더하는, 이름 / 값의 목록

#### 헤더 분류
- 일반 헤더 : 요청과 응답 양쪽에 사용 가능
- 요청 헤더 : 요청에 대한 부가 정보 제공
- 응답 헤더 : 응답에 대한 부가 정보 제공
- Entity 헤더 : 본문 크기와 콘텐츠, 혹은 리소스 자체를 서술
- 확장 헤더 : 명세에 정의되지 않은 새로운 헤더
  - `ex) Date Tue, 3 Oct 1997 02:16:03 GMT`
  - `Content-length: 15040`

#### 헤더를 여러 줄로 나누기
- 헤더를 나눌 때에는 여러 줄로 나눌 때, 추가 줄 앞에는 최소 하나의 스페이스 혹은 탭 필요

### 3.2.4 엔티티 본문

- HTTP 메시지의 세번째 부분으로 선택적으로 실제 데이터를 담는 영역

### 3.2.5 버전 0.9 버전 메시지

![img.png](03_http_msg_02.png)

- 요청과 응답 모두 헤더가 없으며, 요청은 버전 표기가 없고 응답은 상태 코드 및 구절이 없다

## 3.3 메서드

### 3.3.1 안전한 메서드

- GET, HEAD 메서드는 실제적으로 서버에는 아무런 변화를 일으키지 않으므로 안전한 메서드로 구분
- 단, 실제 서버에 작용을 일으키지 않는다고 완전히 보장은 X → 해당 메서드의 목적성을 사용자에게 알리는 용도

### 3.3.2 GET

- 서버의 리소스를 요청하기 위해 사용

### 3.3.3 HEAD

- GET 과 유사하나 헤더만 응답으로 반환
- 리소스를 가져오지 않고 리소스의 타입, 개체의 존재 여부, 리소스 변경 여부 확인 가능

### 3.3.4 PUT

- 요청 본문을 바탕으로 서버에 리소스가 없으면 새로 작성, 있으면 기존의 리소스를 수정

### 3.3.5 POST

- 서버에 입력 데이터를 전송하기 위해 설계(Form)

### 3.3.6 TRACE

- 서버의 응답의 본문에 클라이언트의 요청을 그대로 반환, 이를 통해 통신 과정에서 요청 메시지가 망가졌는지 확인 가능
- 클라이언트와 서버 사이의 `루프백(loopback)` 진단을 위해 사용

> 최근에는 XST(Cross-Site Tracing) 위협으로 인해 대부분의 서버에서 비활성화 </br>
> XSS(Cross-Site Scripting) 을 통해 사용자의 로그인 요청을 TRACE 로 보내게 되면, 사용자의 요청을 서버에서 그대로 돌려주므로 정보 및 헤더에 포함 된 세션 ID 등을 탈취 가능

### 3.3.7 OPTIONS

- 서버에게 지원하는 메서드의 지원 범위를 물어보는 요청 메서드

### 3.3.8 DELETE

- 서버에서 특정 리소스를 삭제하는 것을 요청
- 단, 서버에서 리소스가 삭제되는 것을 보장하는 것은 아님

### 3.3.9 확장 메서드

- HTTP 는 필요에 따라 확장이 가능하여 필요 메서드를 확장하여 사용이 가능하다

> 백엔드 Security 메서드 허용 설정에서 해당 메서드가 HTTP 버전에 따른 enum 과 같이 정의된 타입이 아니라 문자열인 이유

## 3.4 상태 코드

### 3.4.1 100-199: 정보성 상태 코드

- 정보성 상태 코드는 1.1 버전에서 도입

| 상태 코드 |        사유 구절        | 의미                                          |
|:-----:|:-------------------:|:--------------------------------------------|
|  100  |      Continue       | 요청의 시작이 허용 되었으며, 나머지 요청을 계속 보내야 함           |
|  101  | Switching Protocols | 클라이언트가 Upgrade 헤더에 나열할 것 중 하나로 서버가 프로토콜을 변경 |

#### 클라이언트와 100 Continue

- 클라이언트가 대용량 본문 전송 등을 위해 서버의 상태 확인을 위해 사용
- 요청 헤더에 Expect: 100 Continue 를 담아서 전달하고, 해당 요청을 받은 서버는 상황에 따라 특수한 코드인 100 Continue 응답을 보내거나 요청 거부 응답을 보내야 함
- 프록시 사용 시, 홉 서버가 HTTP 버전이 1.1 이하를 사용하는 경우라면 서버가 가능한 상태이더라도 100 Continue 가 아닌 417 Expectation Failed 로 응답 해야함

### 3.4.2 200-299: 성공 상태 코드

- 요청 성공 시의 상태 코드

| 상태 코드 |     사유 구절 (Reason Phrase)     | 의미                                                                             |
|:-----:|:-----------------------------:|:-------------------------------------------------------------------------------|
|  200  |              OK               | 요청은 정상, 응답 본문에 요청한 리소스가 포함                                                     |
|  201  |            Created            | 서버 개체 생성을 위한 `PUT` 요청에 대한 응답, 응답에는 리소스에 대한 Location 헤더와 함께 리소스를 참조할 수 있는 정보 포함 |
|  202  |           Accepted            | 요청은 받아 들여졌으나, 서버는 아직 동작을 수행하지 않았다는 응답. 주로 비동기에 사용                              |
|  203  | Non-Authoritative Information | 요청은 성공했지만, 응답의 메타 정보가 원본 서버가 아닌 프록시 서버에서 왔을 수 있음을 의미                           |
|  204  |          No Content           | 요청은 성공적으로 처리되었으나 응답 본문에 돌려줄 내용이 없는 `DELETE` 사용 시 사용. 폼 리프레쉬 등에 사용              |
|  205  |         Reset Content         | 주로 브라우저를 위해 사용. HTML 의 Form 을 전부 비울 때 사용                                       |
|  206  |        Partial Content        | 부분 혹은 범위 요청의 성공을 의미, `Range` 헤더를 기반으로 범위 요청의 성공을 의미                            |

> 책에는 리소스 생성을 PUT 으로 설명 중인데, AI 는 생성은 POST 수정은 POST 로 이야기 하는 부분에 대한 생각은?

### 3.4.3 300-399: 리다이렉션 상태 코드

- 클라이언트가 요청한 리소스에 대해 다른 위치를 사용하라고 알려주거나, 다른 대안 응답을 제공

| 상태 코드 | 사유 구절 (Reason Phrase) | 의미                                                                     |
|:-----:|:---------------------:|:-----------------------------------------------------------------------|
|  300  |   Multiple Choices    | 요청 된 리소스에 대한 여러 리소의 목록으로 응답 (언어 선택에 케이스 등)                             |
|  301  |   Moved Permanently   | 리소스가 옮겨진 경우, 현재 리소스가 위치하는 URL 을 헤더에 포함해야 함                             |
|  302  |         Found         | 301 의 상태코드, 301 에 포함된 옮겨진 리소스의 위치에서 리소스를 찾은 경우.                        |
|  303  |       See Other       | POST 요청에 대한 응답으로 리소스를 다른 URL(응답 헤더에 포함)에서 GET 으로 메서드를 변경하여 가져와야 함을 의미. |
|  304  |     Not Modified      | 조건부 요청에 대해, 리소스 변화가 없음을 의미                                             |
|  305  |       Use Proxy       | 리소스가 반드시 프록시를 통해 접근해야 함을 전달, 프록시의 위치는 응답 헤더에 포함                        |
|  306  |     Switch Proxy      | 현재 사용 X, 306 응답을 통해 사용자에게 악의적인 프록시 서버 위치 전달이 가능                        |
|  307  |  Temporary Redirect   | 임시적으로 변경 된 리소스의 위치를 응답 헤더에 포함하여 전달                                     |

> 306 안알랴줌.... ㅋㅋㅋㅋㅋㅋ

### 3.4.4 400-499: 클라이언트 에러 상태 코드

- 클라이언트에서 에러가 발생 했음을 의미

| 상태 코드 |      사유 구절 (Reason Phrase)      | 의미                                              |
|:-----:|:-------------------------------:|:------------------------------------------------|
|  400  |           Bad Request           | 클라이언의 잘못된 요청                                    |
|  401  |          Unauthorized           | 인증 요구 응답                                        |
|  402  |        Payment Required         | 현재 사용 X, 미래를 위해 준비                              |
|  403  |            Forbidden            | 요청이 서버에 의해 거부 된 이유를 숨기고 싶을 때 사용                 |
|  404  |            Not Found            | 요청한 URL 을 찾을 수 없을 때                             |
|  405  |       Method Not Allowed        | 요청한 URL 은 존재하나 지원하지 않는 메서드 요청일 경우               |
|  406  |         Not Acceptable          | 서버가 클라이언트 요청 헤더에 명시 된 미디어 타입 중 어떤 것도 응답할 수 없을 때 |
|  407  |  Proxy Authentication Required  | 리소스에 대한 인증을 요구하는 프록시 서버를 위해 사용                  |
|  408  |         Request Timeout         | 응답에 오랜 시간이 걸리는 경우 해당 응답을 보내고 연결을 끊을 때 사용        |
|  409  |            Conflict             | 요청이 충돌을 일으킬 수 있을 때 사용                           |
|  410  |              Gone               | 404와 비슷하나 서버 유지 보수를 위해 일시적으로 제거된 경우에 사용         |
|  411  |         Length Required         | 요청 메세지에 Content-Length 를 요구하는 경우 사용             |
|  412  |       Precondition Failed       | 조건부 요청(`Expect Header`)에서 하나가 실패한 경우            |
|  413  |    Request Entity Too Large     | 서버가 처리할 수 있는 크기 이상의 요청 시 응답으로 사용                |
|  414  |      Request URI Too Long       | 서버가 처리할 수 있는 길이 이상의 URL 요청의 응답                  |
|  415  |     Unsupported Media Type      | 서버가 이해할 수 없는 유형의 데이터 요청 시 사용                    |
|  416  | Requested Range Not Satisfiable | 리소스의 특정 범위 요청이 잘못된 경우 사용                        |
|  417  |       Expectation Failed        | Expect 요청 헤더에 포함된 내용을 서버가 처리할 수 없는 경우에 사용       |

> 413 의 경우 GPT 는 Payload Too Large(HTTP/1.1 개정, 2014) 로 써주는 거 보면, Request Entity(HTTP/1.1, 1999) 에 대한 낯설음이 바로 사라지는 군요 <br>


### 3.4.5 500-599: 서버 에러 상태 코드

- 서버 자체에서 에러가 발생한 경우 사용하는 코드

| 상태 코드 |   사유 구절 (Reason Phrase)    | 의미                                                                |
|:-----:|:--------------------------:|:------------------------------------------------------------------|
|  500  |   Internal Server Error    | 서버가 요청을 처리 불가능할 때 사용                                              |
|  501  |      Not Implemented       | 클라이언트가 서버의 능력을 넘는 요청을 한 경우 사용 (메서드가 지원 되지 않는 경우)                  |
|  502  |        Bad Gateway         | 프록시 또는 게이트웨이와 같이 응답 연쇄 서버가 실제 서버로 부터 받은 응답을 클라이언트로 전달이 불가능한 경우 사용 |
|  503  |    Service Unavailable     | 서버가 현재는 요청을 처리할 수 없을 때 사용. Retry-After 헤더를 통해 서비스 가능 시간 안내 가능     |
|  504  |      Gateway Timeout       | 프록시 또는 게이트웨이 서버에서 실제 서버로 부터 응답을 못 받은 경우에 사용                       |
|  505  | HTTP Version Not Supported | 서버가 지원하지 않는 HTTP 버전일 경우 사용                                        |

## 3.5 헤더

- 일반 헤더 / 요청 헤더 / 응답 헤더 / 언터티 해더 / 확장 헤더로 구성

### 3.5.1 일반 헤더 (General Header)

- 메시지의 종류에 상관 없이 기본적인 정보를 제공하는 헤더

|        헤더         | 설명                                    |
|:-----------------:|:--------------------------------------|
|    Connection     | 클라이언트와 서버가 요청/응답 연결에 대한 옵션을 정하기 위해 사용 |
|       Date        | 메시지가 언제 만들어졌는지에 대한 정보                 |
|   MIME-Version    | 발송자가 사용한 MIME 의 버전 정보                 |
| Transfer-Encoding | 수신자에게 안전한 전송을 위해 적용된 인코딩 정보           |
|      Upgrade      | 발송자가 업그레이드 하기 원하는 버전 혹은 프로토콜 정보       |
|        Via        | 이 메시지가 어떤 중개자(프록시, 게이트웨이)를 거쳐 왔는지 정보  |

#### 일반 캐시 헤더
- HTTP/1.0 에서 적용 된 헤더로, 매번 서버로 부터 정보를 가져 오는 것이 아니라 로컬 복사본으로 캐시할 수 있도록 하는 헤더

|      헤더       | 설명                           |
|:-------------:|:-----------------------------|
| Cache-Control | 메시지와 함개 캐시 지시자를 전달하는 용도      |
|    Pragma     | 메시지화 함께 지시자를 전달, 캐시에 국한되지 않음 |

### 3.5.2 요청 헤더

- 요청 메시지에서만 의미를 가지는 헤더

