# 05. 웹 서버

- 여러 종류의 소프트웨어 및 하드웨어 웹 서버에 대해 조사한다
- HTTP 통신을 진단해주는 간단한 웹 서버를 펄(Perl)로 작성해본다
- 어떻게 웹 서버가 HTTP 트랜잭션을 처리하는지 단꼐별로 설명한다

## 5.1 다채로운 웹 서버

- 웹 서버는 HTTP 요청을 처리하고 응답을 제공

### 5.1.1 웹 서버 구현

- 웹 서버는 HTTP 프로토콜을 구현하고, 웹 리소스를 관리하고, 웹 서버의 관리 기능을 제공
- 웹 서버는 TCP 커넥션 관리에 대한 책임을 운영체제와 나눠 가진다

### 5.1.2 다목적 소프트웨어 웹 서버

### 5.1.3 임베디드 웹 서버

- 소비자용 제품에 내장 될 목적으로 만들어진 작은 웹 서버

## 5.2 간단한 Perl 웹 서버

- 간단한 type-o-serve 유틸리티는 간단한 형태로 서버 응답 메시지를 생성 할 수 있도록 한다

*perl 코드*
```perl
#!/user/bin/perl

use Socket;
use Carp;
use FileHandle;

# 8080 포트가 기본
$port = (@ARGV ? $ARGV[0] : 8080)

# 로컬 TCP 소켓을 생성하고 커넥션을 대기(listen)
$proto = getprotobyname('tcp')
socket(S, PF_INET, SOCK_STREAM, $proto) || die;
setsockopt(S, SOL_SOCKET, SO_REUSEADDR, pack("l", 1)) || die;
bind(S, sockaddr_in($port, INADDR_ANY)) || die;
listen(S, SOMAXCONN) || die;

# 시작 메시지 출력
printf("    <<<Type-O-Serve Accepting on Port %d>>>\n\n", $port);

while (1)
{
    # 커넥션 대기
    $cport_caddr = accept(C, S);
    ($cport, $caddr) = sockaddr_in($cport_caddr);
    C -> autoflush(1);
    
    # 커넥션 출처 출력
    $cname = gethostbyaddr($caddr, AF_INET);
    printf("    <<<Request From '%s'>>>\n" $cname);
    
    # 빈 줄이 나올 때까지 요청 메시지를 읽어서 출력
    while ($line = <C>)
    {
        print $line;
        if ($line =~ /^\r/) { last; }
    }
    
    # 응답 메시지를 위한 프롬프트를 만들고, '.' 하나만 있는 응답이 입력 될 때 까지 응답 줄 입력 받기
    printf("    <<<Type Response Followed by '.'>>>\n");
    
    while ($line = <STDIN>)
    {
        $line =~ s/\r//;
        $line =~ s/\n//;
        if ($line =~ /^\./) { last; }
        print C $line . "\r\n";
    }
    close(C);
}
```

*js 코드*
```javascript
const net = require('net');
const readline = require('readline');

// 8080 포트가 기본
const port = process.argv[2] ? parseInt(process.argv[2]) : 8080;

// TCP 서버 생성
const server = net.createServer((socket) => {
    // 커넥션 출처 출력
    const clientAddress = socket.remoteAddress;
    const clientPort = socket.remotePort;
    console.log(`    <<<Request From '${clientAddress}:${clientPort}'>>>\n`);

    let requestData = '';

    // 클라이언트로부터 데이터 수신
    socket.on('data', (data) => {
        const lines = data.toString().split('\n');

        for (let line of lines) {
            console.log(line);
            requestData += line + '\n';

            // 빈 줄이 나오면 요청 종료
            if (line.match(/^\r?$/)) {
                handleResponse(socket);
                break;
            }
        }
    });

    socket.on('error', (err) => {
        console.error('Socket error:', err);
    });
});

// 응답 처리 함수
function handleResponse(socket) {
    console.log("    <<<Type Response Followed by '.'>>>");

    const rl = readline.createInterface({
        input: process.stdin,
        output: process.stdout
    });

    rl.on('line', (line) => {
        // '.'만 입력되면 종료
        if (line.trim() === '.') {
            rl.close();
            socket.end();
            return;
        }

        // 응답을 클라이언트에게 전송
        socket.write(line + '\r\n');
    });

    rl.on('close', () => {
        socket.end();
    });
}

// 서버 시작
server.listen(port, () => {
    console.log(`    <<<Type-O-Serve Accepting on Port ${port}>>>\n`);
});

server.on('error', (err) => {
    console.error('Server error:', err);
    process.exit(1);
});
```

![img.png](images/05_web_server.png)

- 8080 번 포트에서 type-o-serve 서버가 시작
- type-o-serve 서버는 브라우저에서 HTTP 요청 메세지를 받고 그 내용을 화면의 출력한 뒤, 관리자가 "." 마침표 하나로 끝나는 간단한 응답 메세지를 입력할 때 까지 대기
- 관리자의 응답 메시지를 브라우저에 돌려주고, 브라우저는 응답 메세지의 본문을 화면에 출력